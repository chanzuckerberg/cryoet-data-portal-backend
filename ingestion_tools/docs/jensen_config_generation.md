# Generating ingestion config files for Jensen Datasets

## Motivation
The data submission for Grant Jensen includes a large number of datasets, which is very hard to create or maintain individually. Therefore we have tooling to automate the generation of these config files from the raw metadata.

## Source Data
The source data to create the config files can be found [here](https://github.com/czimaginginstitute/czii-data-portal-processing/tree/main/src/data_portal_processing/jensendb). This directory contains the data provided by the author, along with some additional metadata from the curators.

### The dataset files (portal_*.json)

The file name corresponds to the Dataset ID in the cryoET portal (ie) `portal_{dataset_id}.json`.

This file provides the information on entities for each run.

### Cross-References (cross_references.json)
The provides information on the cross-references by dataset id.

### Depositions
There are two files to provide the deposition information for these datasets

#### portal_dataset_grouping.json
Provides the information on which deposition a dataset belongs to.

#### deposition_dataset.json
Provides the information needed to populate the deposition metadata.

### Dose Rate (run_dose_rate_map.tsv)
The dose_rate to be used for a run's frame metadata.

## Files Generated

All the files generated should live inside the output directory, which defaults to `../dataset_configs/gjensen`. Running the script will overwrite any existing file of the same path.

### yaml files
The config files are generated for each dataset, and are available directly inside the `gjensen` folder.

### run_data_map
This folder holds the csv files for runs where there are different values for specific fields between runs.

This is not present for all the dataset.

### run_frames_map
If there are multiple tomogram folders for a run, specify the name of the canonical tomogram's folder. This is used in one of the paths for finding rawtlt files.

This is not present for all the dataset.

### run_tomo_map
If there are multiple tomogram folders for a run, specify the path of the canonical tomogram. This is used in the paths for the tomograms.

This is not present for all the dataset.

## Running the script

### Cloning dependency
As mentioned earlier, there is a dependency on https://github.com/czimaginginstitute/czii-data-portal-processing repository. This needs to be available in your workspace.

#### tl;dr:
```bash
# Navigate to wherever your workspace is
cd ~/workspace

# Clone the git repository
git clone git@github.com:czimaginginstitute/czii-data-portal-processing.git .
```

### Updating the configs

To generate the configs in the default location, provide the path to the `jensendb` folder in the repository mentioned above.

```bash
cd ingestion_tools/scripts

python gjensen_config.py create ~/workspace/czii-data-portal-processing/src/data_portal_processing/jensendb
```


To generate the configs in a custom location, provide an additional input of the destination location.
```bash
cd ingestion_tools/scripts

python gjensen_config.py create ~/workspace/czii-data-portal-processing/src/data_portal_processing/jensendb ~/workspace/custom_location
```

### Note:
#### If there are any updates to the csv files generated, they should be synced over to the s3 bucket before the PR is merged to main.

## Migration Notes

The initial outcome of this script is the config in a much older format which is not compatible with the current format.

To ensure that config generated by this script are up to date, we automatically apply the migrations that are defined in [schema_migration](../schema_migration).
